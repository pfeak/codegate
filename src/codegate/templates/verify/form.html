{% extends "base.html" %}

{% block title %}核销验证 - CodeGate{% endblock %}

{% block content %}
<!--
页面功能：核销验证页
主要数据绑定：
- verification: 核销结果对象
- recent_verifications: 最近核销记录列表
-->
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">核销验证</h1>
        <p class="text-gray-600 mt-1">验证激活码是否有效并完成核销</p>
    </div>

    <!-- 核销表单卡片 -->
    <div class="bg-white shadow-sm rounded-lg p-6 mb-6">
        <form id="verify-form" onsubmit="return verifyCode(event)">
            <div class="mb-4">
                <label for="code" class="block text-sm font-medium text-gray-700 mb-2">激活码 *</label>
                <input type="text" id="code" name="code" required autofocus
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg font-mono"
                    placeholder="请输入激活码（支持粘贴，自动去除空格）">
            </div>

            <div class="mb-4">
                <label for="verified_by" class="block text-sm font-medium text-gray-700 mb-2">核销用户（可选）</label>
                <input type="text" id="verified_by" name="verified_by"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="请输入核销用户标识">
            </div>

            <button type="submit" id="verify-btn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-md transition-colors text-lg font-semibold">
                <i class="fas fa-check-circle mr-2"></i>验证
            </button>
        </form>
    </div>

    <!-- 核销结果区域 -->
    <div id="result-container" class="hidden mb-6">
        <div id="result-success" class="hidden bg-white shadow-sm rounded-lg p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-check-circle text-4xl text-green-600 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold text-green-600">核销成功</h2>
                    <p class="text-gray-600" id="success-message"></p>
                </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-500">项目名称</div>
                        <div class="font-semibold text-gray-900" id="result-project-name">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">核销时间</div>
                        <div class="font-semibold text-gray-900" id="result-verified-at">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="result-failed" class="hidden bg-white shadow-sm rounded-lg p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-times-circle text-4xl text-red-600 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold text-red-600">核销失败</h2>
                    <p class="text-gray-600" id="failed-message"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史核销记录 -->
    <div class="bg-white shadow-sm rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">历史核销记录</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">激活码
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">核销时间
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">核销用户
                        </th>
                    </tr>
                </thead>
                <tbody id="logs-table" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无记录</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // API 请求封装
    async function apiRequest(method, url, data = null) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'include'
        };

        if (data) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);

            // 处理 401 未认证
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || '请求失败');
            }

            return result;
        } catch (error) {
            console.error('API 请求错误:', error);
            throw error;
        }
    }

    // 时间戳转换工具函数
    function timestampToLocal(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp * 1000);  // 转换为毫秒
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 自动去除空格
    document.getElementById('code').addEventListener('paste', function (e) {
        setTimeout(() => {
            this.value = this.value.replace(/\s+/g, '');
        }, 0);
    });

    document.getElementById('code').addEventListener('input', function (e) {
        this.value = this.value.replace(/\s+/g, '');
    });

    async function verifyCode(event) {
        event.preventDefault();

        const verifyBtn = document.getElementById('verify-btn');
        const originalText = verifyBtn.innerHTML;
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>验证中...';

        const code = document.getElementById('code').value.trim().replace(/\s+/g, '');
        const verifiedBy = document.getElementById('verified_by').value.trim() || null;

        if (!code) {
            Toast.error('请输入激活码');
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = originalText;
            return false;
        }

        try {
            const result = await apiRequest('POST', '/api/codes/verify', {
                code: code,
                verified_by: verifiedBy,
            });

            // 保存日志
            saveLog(code, result.success, result.message, verifiedBy, result.project_name);

            // 显示结果
            document.getElementById('result-container').classList.remove('hidden');

            if (result.success) {
                document.getElementById('result-success').classList.remove('hidden');
                document.getElementById('result-failed').classList.add('hidden');
                document.getElementById('success-message').textContent = result.message;
                document.getElementById('result-project-name').textContent = result.project_name || '-';
                document.getElementById('result-verified-at').textContent = timestampToLocal(result.verified_at);

                // 显示成功 Toast
                Toast.success(result.message || '核销成功');

                // 清空表单（可选，也可以保留以便继续核销）
                document.getElementById('code').value = '';
                document.getElementById('code').focus();
            } else {
                document.getElementById('result-success').classList.add('hidden');
                document.getElementById('result-failed').classList.remove('hidden');
                document.getElementById('failed-message').textContent = result.message;

                // 显示失败 Toast
                Toast.error(result.message || '核销失败');
            }

            // 刷新日志
            loadLogs();
        } catch (error) {
            console.error('核销验证失败:', error);
            Toast.error(`核销验证失败: ${error.message || '未知错误'}`);
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = originalText;
        }

        return false;
    }

    // 保存核销记录到 localStorage
    function saveLog(code, success, message, verifiedBy, projectName) {
        const logs = JSON.parse(localStorage.getItem('recent_verify_logs') || '[]');
        logs.unshift({
            code: code,
            success: success,
            message: message,
            verified_by: verifiedBy,
            project_name: projectName,
            time: new Date().toISOString(),
        });

        // 只保留最近 20 条
        if (logs.length > 20) {
            logs.pop();
        }

        localStorage.setItem('recent_verify_logs', JSON.stringify(logs));
    }

    async function loadLogs() {
        // 从 localStorage 获取最近核销记录
        const recentLogs = JSON.parse(localStorage.getItem('recent_verify_logs') || '[]');

        const tbody = document.getElementById('logs-table');
        if (recentLogs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无记录</td></tr>';
            return;
        }

        // 只显示成功的核销记录
        const successLogs = recentLogs.filter(log => log.success).slice(0, 20);

        if (successLogs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">暂无记录</td></tr>';
            return;
        }

        tbody.innerHTML = successLogs.map(log => {
            const verifiedAt = log.time ? timestampToLocal(new Date(log.time).getTime() / 1000) : '-';
            return `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${log.code}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.project_name || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${verifiedAt}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.verified_by || '-'}</td>
            </tr>
        `;
        }).join('');
    }

    // 初始加载日志
    loadLogs();
</script>
{% endblock %}