{% extends "base.html" %}

{% block title %}邀请码列表 - CodeGate{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">邀请码列表</h1>
        <p class="text-gray-600 mt-1">项目: <span id="project-name">加载中...</span></p>
    </div>

    <div class="bg-white shadow rounded-lg p-6">
        <div class="mb-4">
            <input type="text" id="code-search" placeholder="搜索邀请码..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">邀请码
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">核销时间
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">核销用户
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间
                        </th>
                    </tr>
                </thead>
                <tbody id="codes-table" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-700">
                共 <span id="code-total-count">0</span> 个邀请码
            </div>
            <div class="flex space-x-2" id="code-pagination">
            </div>
        </div>
    </div>
</div>

<script>
    // 从 URL 获取项目 ID
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project_id');

    if (!projectId) {
        document.body.innerHTML = '<div class="p-6 text-center text-red-600">缺少项目ID参数</div>';
    } else {
        loadProject();
        loadCodes();
    }

    async function loadProject() {
        try {
            const response = await fetch(`/api/projects/${projectId}`);
            const project = await response.json();
            document.getElementById('project-name').textContent = project.name;
        } catch (error) {
            console.error('加载项目信息失败:', error);
        }
    }

    async function loadCodes(page = 1, search = '') {
        try {
            const params = new URLSearchParams({
                page: page.toString(),
                page_size: 50,
            });
            if (search) {
                params.append('search', search);
            }

            const response = await fetch(`/api/projects/${projectId}/codes?${params}`);
            const data = await response.json();

            const tbody = document.getElementById('codes-table');
            document.getElementById('code-total-count').textContent = data.total;

            if (data.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无邀请码</td></tr>';
                return;
            }

            tbody.innerHTML = data.items.map(code => {
                const statusBadge = code.status
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已核销</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">未核销</span>';

                const verifiedAt = code.verified_at
                    ? new Date(code.verified_at).toLocaleString('zh-CN')
                    : '-';

                const createdAt = new Date(code.created_at).toLocaleString('zh-CN');

                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${code.code}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${verifiedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${code.verified_by || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdAt}</td>
                </tr>
            `;
            }).join('');

            // 更新分页
            updateCodePagination(data.total, page);
        } catch (error) {
            console.error('加载邀请码列表失败:', error);
        }
    }

    function updateCodePagination(total, page) {
        const totalPages = Math.ceil(total / 50);
        const pagination = document.getElementById('code-pagination');

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        if (page > 1) {
            html += `<button onclick="loadCodes(${page - 1})" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">上一页</button>`;
        }

        for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
            html += `<button onclick="loadCodes(${i})" 
                 class="px-3 py-1 border border-gray-300 rounded text-sm ${i === page ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">${i}</button>`;
        }

        if (page < totalPages) {
            html += `<button onclick="loadCodes(${page + 1})" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">下一页</button>`;
        }

        pagination.innerHTML = html;
    }

    // 搜索功能
    document.getElementById('code-search').addEventListener('input', (e) => {
        const search = e.target.value;
        loadCodes(1, search);
    });
</script>
{% endblock %}