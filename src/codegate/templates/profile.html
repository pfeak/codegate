{% extends "base.html" %}

{% block title %}个人管理 - CodeGate{% endblock %}

{% block extra_head %}
<script src="/static/js/components.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">个人管理</h1>

    <!-- 个人信息卡片 -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">个人信息</h2>
        <div class="space-y-3">
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 w-24">用户名：</span>
                <span class="text-sm text-gray-900" id="adminUsername">-</span>
            </div>
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 w-24">创建时间：</span>
                <span class="text-sm text-gray-900" id="adminCreatedAt">-</span>
            </div>
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 w-24">最后登录：</span>
                <span class="text-sm text-gray-900" id="adminLastLoginAt">-</span>
            </div>
        </div>
    </div>

    <!-- 修改密码卡片 -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">修改密码</h2>
        <form id="changePasswordForm" class="space-y-4">
            <!-- 当前密码 -->
            <div>
                <label for="old_password" class="block text-sm font-medium text-gray-700 mb-2">
                    当前密码 <span class="text-red-500">*</span>
                </label>
                <input type="password" id="old_password" name="old_password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="请输入当前密码">
            </div>

            <!-- 新密码 -->
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                    新密码 <span class="text-red-500">*</span>
                </label>
                <input type="password" id="new_password" name="new_password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="至少8位，包含字母和数字">
                <p class="mt-1 text-sm text-gray-500">至少8位，包含字母和数字</p>
            </div>

            <!-- 确认新密码 -->
            <div>
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                    确认新密码 <span class="text-red-500">*</span>
                </label>
                <input type="password" id="confirm_password" name="confirm_password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="请再次输入新密码">
            </div>

            <!-- 错误提示 -->
            <div id="errorMessage" class="hidden text-red-600 text-sm"></div>

            <!-- 修改密码按钮 -->
            <button type="submit" id="changePasswordButton"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                <span id="changePasswordButtonText">修改密码</span>
                <i id="changePasswordButtonIcon" class="fas fa-spinner fa-spin hidden ml-2"></i>
            </button>
        </form>
    </div>
</div>

<script>
    // 时间戳转换为本地时间字符串
    function timestampToLocal(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // 加载管理员信息
    async function loadAdminInfo() {
        try {
            const response = await fetch('/api/auth/me', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('adminUsername').textContent = data.username;
                document.getElementById('adminCreatedAt').textContent = timestampToLocal(data.created_at);
                document.getElementById('adminLastLoginAt').textContent = timestampToLocal(data.last_login_at);
            } else if (response.status === 401) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('加载管理员信息错误:', error);
        }
    }

    // 页面加载时获取管理员信息
    loadAdminInfo();

    // 修改密码表单提交
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const oldPassword = document.getElementById('old_password').value.trim();
        const newPassword = document.getElementById('new_password').value.trim();
        const confirmPassword = document.getElementById('confirm_password').value.trim();
        const changePasswordButton = document.getElementById('changePasswordButton');
        const changePasswordButtonText = document.getElementById('changePasswordButtonText');
        const changePasswordButtonIcon = document.getElementById('changePasswordButtonIcon');
        const errorMessage = document.getElementById('errorMessage');

        // 前端验证
        if (!oldPassword || !newPassword || !confirmPassword) {
            errorMessage.textContent = '请填写所有字段';
            errorMessage.classList.remove('hidden');
            return;
        }

        if (newPassword.length < 8) {
            errorMessage.textContent = '新密码长度至少8位';
            errorMessage.classList.remove('hidden');
            return;
        }

        if (!/[a-zA-Z]/.test(newPassword)) {
            errorMessage.textContent = '新密码必须包含字母';
            errorMessage.classList.remove('hidden');
            return;
        }

        if (!/[0-9]/.test(newPassword)) {
            errorMessage.textContent = '新密码必须包含数字';
            errorMessage.classList.remove('hidden');
            return;
        }

        if (newPassword !== confirmPassword) {
            errorMessage.textContent = '确认密码与新密码不一致';
            errorMessage.classList.remove('hidden');
            return;
        }

        // 显示加载状态
        changePasswordButton.disabled = true;
        changePasswordButtonText.textContent = '修改中...';
        changePasswordButtonIcon.classList.remove('hidden');
        errorMessage.classList.add('hidden');

        try {
            const response = await fetch('/api/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword,
                    confirm_password: confirmPassword,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                // 修改成功
                Toast.success('密码修改成功');

                // 清空表单
                document.getElementById('changePasswordForm').reset();
            } else {
                // 修改失败
                errorMessage.textContent = data.detail || '密码修改失败';
                errorMessage.classList.remove('hidden');
                Toast.error(data.detail || '密码修改失败');
            }
        } catch (error) {
            console.error('修改密码错误:', error);
            errorMessage.textContent = '网络连接失败，请稍后重试';
            errorMessage.classList.remove('hidden');
            Toast.error('网络连接失败，请稍后重试');
        } finally {
            // 恢复按钮状态
            changePasswordButton.disabled = false;
            changePasswordButtonText.textContent = '修改密码';
            changePasswordButtonIcon.classList.add('hidden');
        }
    });
</script>
{% endblock %}